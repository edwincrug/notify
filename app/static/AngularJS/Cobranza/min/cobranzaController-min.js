registrationModule.controller("cobranzaController",function(e,o,t,n,r,a,i){function c(n){e.idCliente=mySplit(n,0,"|"),$("#search").val(""),e.cliente=Enumerable.From(e.listadeClientes).Where(function(o){return o.idActa==e.idCliente}).OrderBy(function(e){return e.idActa}).Select(function(e){return e}).FirstOrDefault(),o.cliente=e.cliente,t.set("clienteActual",o.cliente),e.myPromise=r.getDatos(e.cliente.idActa).success(l).error(p),e.myPromise=r.getFacturas(e.cliente.idContrato).success(u).error(p),e.$apply()}function s(){}e.x=new Date,e.y=new Date,e.pagoReferencia="",e.pagoMonto=0,e.sFolio="",e.sCliente="",e.semilla="",e.Clear=function(){e.semilla=""};var l=function(e,t){o.datosCliente=e},u=function(e,t){i.success("Datos cargardos"),o.listaFacturas=e},d=function(o,t){o.length>0&&window.open(global_settings.urlReportRecibo+o.replace(/"/g,""),"RptWindow","width=1024, height=768"),$("#btnProcesarPago").button("reset"),$("#newPago").modal("hide"),e.init(),i.success("Pago procesado")},m=function(o,t){e.clientes=o,$("#search").autocomplete({source:e.clientes})},p=function(e,o,t,n){i.error("No se pudieron obtener los datos.")};e.init=function(){o.cliente=t.get("clienteActual"),e.cliente=o.cliente,e.empleado=t.get("employeeLogged"),e.listadeClientes=t.get("listadeClientes"),e.myPromise=r.getDatos(e.cliente.idActa).success(l).error(p),e.myPromise=r.getFacturas(e.cliente.idContrato).success(u).error(p),e.myPromise=n.get(2).success(m).error(p),$("#search").on("autocompleteselect",function(e,o){c(o.item.value)}).change(),e.cuentaDePago="No identificado",e.labelFormaDePago="Seleccione Una Opción",e.labelPromocion="Seleccione Una Opción"};var f=function(n,a,c,s){isNumber(n)?(e.idCliente=n,e.cliente=Enumerable.From(e.listadeClientes).Where(function(o){return o.idActa==e.idCliente}).OrderBy(function(e){return e.idActa}).Select(function(e){return e}).FirstOrDefault(),o.cliente=e.cliente,t.set("clienteActual",o.cliente),e.myPromise=r.getDatos(e.cliente.idActa).success(l).error(p),e.myPromise=r.getFacturas(e.cliente.idContrato).success(u).error(p)):i.error("Error interno al obtener el cliente: "+n)};e.BuscarFolio=function(){r.getFacturasByFolio(e.sFolio).success(f).error(p)},e.ReporteClientes=function(){location.href="/reporteclientes"},e.ReporteFacturas=function(){location.href="/reportefacturas"},e.EmitirFactura=function(){location.href="/factura"},e.MostrarPago=function(){e.recibo=!1,$("#newPago").modal("show")},e.ProcesarPago=function(){confirm("¿Desea procesar el pago por: $ "+e.pagoMonto+"?")&&($("#btnProcesarPago").button("loading"),r.Pagar(e.cliente.idContrato,e.pagoReferencia,e.pagoMonto,e.dt.format("yyyymmdd"),e.recibo,e.cliente.idActa+" | "+e.cliente.razonSocial).success(d).error(p))},e.AbrirCuenta=function(e){window.open(e)};var g=function(o,t){var n=o;$("#btnCancelarFactura").button("reset"),i.warning("La solicitud se ha enviado al administrador para su revisión."),e.init(),$("#showCancel").modal("hide")},P=function(o,t){var n=o;$("#btnCancelarFactura").button("reset"),n.length<10?(i.success("Pago cancelado."),e.init()):i.error("Error al cancelar el pago: "+n)};e.ConfirmarCancelar=function(){$("#btnCancelarFactura").button("loading"),a["delete"](e._id,e.empleado.idEmpleado,e.motivoCancelacion).success(g).error(p)},e.CancelarCuenta=function(o,t){1==t?(e._id=o,$("#showCancel").modal("show")):confirm("¿Desea cancelar el pago?")&&r["delete"](o).success(P).error(p)};var y=function(o,t,n,r){e.listaPromocion=o,C(),$("#newPromocion").modal("show")};e.Promocion=function(){r.getPromocion().success(y).error(p)};var D=function(o,t){var n=o;$("#btnProcesaPromocion").button("reset"),o.length<10?($("#newPromocion").modal("hide"),i.success("Factura Generada."),e.init()):i.error("Ha ocurrido un error al procesar la factura: "+o)};e.ProcesarPromocion=function(){if(confirm("¿Desea procesar la promoción?")){var o=[];if(angular.forEach(e.gridOptions.selectedItems,function(e,t){o.push(e.id)}),1==o.length){$("#btnProcesaPromocion").button("loading");var t=e.dtPromoDesde.format("yyyymmdd"),n=e.dtPromoHasta.format("yyyymmdd");e.promocion=o[0],a.promocion(e.cliente.idContrato,e.promocion,t,n,e.promocionFormaDePago,1).success(D).error(p)}else i.error("Debe seleccionar una promoción.")}},s.prototype.id="",s.prototype.descripcion="",e.myData=[],e.gridOptions={data:"myData",columnDefs:[{field:"descripcion",displayName:"Promoción"}],selectedItems:[],keepLastSelected:!1};var C=function(){e.myData=[],angular.forEach(e.listaPromocion,function(e,o){var t=new s;t.id=e.idPromocion,t.descripcion=e.descripcion,this.push(t)},e.myData)};e.BuscarCliente=function(){r.getFacturasByCliente(e.sCliente).success(byClienteSuccess).error(p)},e.today=function(){e.dt=new Date,e.dtPromoDesde=new Date,e.dtPromoHasta=new Date},e.today(),e.clear=function(){e.dt=null,e.dtPromoDesde=null,e.dtPromoHasta=null},e.disabled=function(e,o){return"day"===o&&(-1===e.getDay()||7===e.getDay())},e.toggleMin=function(){e.minDate=e.minDate?null:(new Date).addYears(-1)},e.toggleMin(),e.open=function(o){o.preventDefault(),o.stopPropagation(),e.opened=!0},e.openPromoDesde=function(o){o.preventDefault(),o.stopPropagation(),e.openedPromoDesde=!0},e.openPromoHasta=function(o){o.preventDefault(),o.stopPropagation(),e.openedPromoHasta=!0},e.dateOptions={formatYear:"yy",startingDay:1},e.initDate=new Date("2016-15-20"),e.formats=["dd-MMMM-yyyy","yyyy/MM/dd","dd.MM.yyyy","shortDate"],e.format=e.formats[0],e.SetPago=function(o,t,n){t.preventDefault(),t.stopPropagation(),e.status.isopenFormaDePago=!e.status.isopenFormaDePago,e.promocionFormaDePago=o,e.labelFormaDePago=n},e.SetPromocion=function(o,t,n){t.preventDefault(),t.stopPropagation(),e.status.isopenPromocion=!e.status.isopenPromocion,e.promocion=o,e.labelPromocion=n}});