registrationModule.controller("salaMonitorController",function(e,a,t,r,n){function o(){}e.isCollapsed=!0;var i=function(a,t,r,n){e.listaReservacionesMonitor1=a,e.lastUpdate=(new Date).format("dd/mm/yy hh:MM")},s=function(a,t,r,n){e.listaReservacionesMonitor2=a,e.lastUpdate=(new Date).format("dd/mm/yy hh:MM")},c=function(e,a,t,r){n.error("Ocurrio un problema al obtener los datos.")};e.Reload=function(){e.myPromise=r.getReservacionMonitor(1).success(i).error(c),e.myPromise=r.getReservacionMonitor(2).success(s).error(c)},e.init=function(){e.Reload(),a.empleado=t.get("employeeLogged"),e.empleado=a.empleado,e.listadeContactos=t.get("listadeContactos"),e.listadeClientes=t.get("listadeClientes");var r=setInterval(function(){e.Reload()},18e4)};var l=function(a,t,r,o){e.isCollapsed=!e.isCollapsed,$("#btnCerrarSala").button("reset"),e.Reload(),n.success("Sala cerrada correctamente."),location.reload()};e.TerminarCierre=function(){e.cierreExcedente>0?confirm("Â¿Desea cerrar la sala con un excedente de "+e.cierreExcedente+" hora(s)?")&&d():d()};var d=function(){var a=[];angular.forEach(e.gridOptions.selectedItems,function(e,t){a.push(e.mail)}),a.length>0?($("#btnCerrarSala").button("loading"),e.listaContactoTemp=Enumerable.From(e.listaContacto).Where(function(e){return $.inArray(e.mail,a)>-1}).OrderBy(function(e){return e.idContacto}).Select(function(e){return e}).ToArray(),e.currentSala.contactos=e.listaContactoTemp,e.currentSala.desde=(new Date).format("yyyymmddHHMM"),e.currentSala.horas=e.cierreExcedente,r.terminarCierre(e.currentSala).success(l).error(l)):n.error("Debe seleccionar un contacto.")};e.CerrarSala=function(a){if(3==a.etapa){if(e.isCollapsed=!e.isCollapsed,e.currentSala=_Sala,!e.isCollapsed){e.cliente=Enumerable.From(e.listadeClientes).Where(function(e){return e.idContrato==a.idContrato}).OrderBy(function(e){return e.idActa}).Select(function(e){return e}).FirstOrDefault(),e.listaContacto=Enumerable.From(e.listadeContactos).Where(function(a){return a.idActa==e.cliente.idActa}).OrderBy(function(e){return e.idContacto}).Select(function(e){return e}).ToArray(),f();var t=(new Date).getTime();$("#firmaMonitor").attr("src",global_settings.urlSignature+t.toString()),e.cierreCliente=a.cliente,e.cierreInicio=a.desde,e.cierreFin=a.hasta,e.cierreSalida=(new Date).format("HH:MM:ss");var r=0,o=Math.trunc((a.transcurridos-a.reservados)/60);r=o,(a.transcurridos-a.reservados)%60>=15&&(a.transcurridos-a.reservados)%60<=44&&(r+=.5),(a.transcurridos-a.reservados)%60>=45&&(a.transcurridos-a.reservados)%60<=59&&(r+=1),0>r&&(r=0),e.cierreExcedente=r,e.currentSala.contactos=e.listaContacto,e.currentSala.idEmpleado=e.empleado.idEmpleado,e.currentSala.idReservacion=a.idReservacion,e.currentSala.idContrato=a.idContrato,e.currentSala.sucursal=2,e.currentSala.firma=t.toString()}}else n.info("Debe marcar la entrada antes de cerrar la sala.")};var u=function(a,t,r,o){$("#extendSala").modal("hide"),e.Reload(),n.success("Sala extendida correctamente.")};e.TerminarExtender=function(){r.extenderSala(e.extendSala.idReservacion,e.extendSala.idSala,new Date(e.mydesde).format("yyyymmddHHMM"),new Date(e.myhasta).format("yyyymmddHHMM")).success(u).error(c)},e.Extender=function(a){$("#extendSala").modal("show"),e.extendSala=a,e.mydesde=e.extendSala.desdeF,e.myhasta=e.extendSala.hastaF},e.toggleSala=function(a,t){a.preventDefault(),a.stopPropagation(),e.status.isopen=!e.status.isopen,e.extendSala.idSala=t,e.extendSala.sala=a.target.innerText},e.Cancelar=function(){e.isCollapsed=!e.isCollapsed};var m=function(a,t,r,n){$(".btnVista").button("reset"),e.Reload()};e.MarcarVista=function(e){3!=e.tipo?($(".btnVista").button("loading"),r.changeStage(e.idReservacion,2).success(m).error(c)):e.etapa>1&&3==e.tipo?n.success("Sala liberada, ahora puede marcar la entrada."):n.info("El departamento de cobranza debe confirmar el pago antes de marcar la reservacion como vista.")},e.ShowComment=function(a){e.comentarios=a.comentarios,$("#viewComentarios").modal("show")};var m=function(a,t,r,n){$(".btnEntrada").button("reset"),e.Reload()};e.MarcarEntrada=function(e){e.etapa>1?($(".btnEntrada").button("loading"),r.changeStage(e.idReservacion,3).success(m).error(c)):n.info("Debe marcar la sala como vista antes de iniciar.")},o.prototype.name="",o.prototype.mail="",e.myData=[],e.gridOptions={data:"myData",columnDefs:[{field:"name",displayName:"Nombre"},{field:"mail",displayName:"Correo"}],selectedItems:[],keepLastSelected:!1};var f=function(){e.myData=[],angular.forEach(e.listaContacto,function(e,a){var t=new o;t.name=e.nombre,t.mail=e.mail,""!=t.mail&&this.push(t)},e.myData)};e.hstep=1,e.mstep=30,e.ismeridian=!1});