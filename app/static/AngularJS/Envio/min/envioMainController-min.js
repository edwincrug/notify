registrationModule.controller("envioMainController",function(e,t,n,r,o){function a(){}e.color="#3a75c4",e.usingCalendar=!1,e.horas=0,e.desde="",e.hasta="";var i=null,l=null,c;a.prototype.name="",a.prototype.mail="",e.myData=[],e.gridOptions={data:"myData",columnDefs:[{field:"name",displayName:"Nombre"},{field:"mail",displayName:"Correo"}],selectedItems:[],keepLastSelected:!1};var u=function(e,t,n,r){$("#btnEnviar").button("reset"),o.error("Ocurrio un problema: "+e.Message)};e.init=function(){t.cliente=n.get("clienteActual"),e.cliente=t.cliente,l={header:{left:"prev,next today",center:"title",right:"agendaDay"},editable:!0,defaultView:"agendaDay",isRTL:!1,height:550,allDaySlot:!1,selectable:!0,selectHelper:!0,select:function(t,n){if(e.usingCalendar)return alert("Debe limpiar la selección actual."),void i.fullCalendar("unselect");var r="Nuevo envío";r&&(c={title:r,start:t,end:n,id:1},e.currentEvent=c,e.MakeEvent())},eventColor:e.color,eventOverlap:!1,timezone:"UTC"},e.objetoEnvio=_Envio,e.listaContacto=n.get("listaContacto"),angular.forEach(e.listaContacto,function(e,t){var n=new a;n.name=e.nombre,n.mail=e.mail,""!=n.mail&&this.push(n)},e.myData)};var s=function(){i.fullCalendar("removeEvents"),m(e.dt)},d=function(e,t,n,r){e?angular.forEach(e,function(e,t){i.fullCalendar("renderEvent",{title:e.titulo,start:e.desde,end:e.hasta,allDay:!1,id:e.idEnvio},!0)}):o.error("Error al obtener los eventos.")},m=function(t){var n=t.format("yyyymmdd");e.myPromise=r.getEvents(n).success(d).error(u)},v=function(t,n,r,a){0==t?(i.fullCalendar("renderEvent",e.currentEvent,!0),e.usingCalendar=!0,e.ShowDetail()):(e.objetoEnvio=_Envio,e.usingCalendar=!1,i.fullCalendar("removeEvents","1"),o.error("El horario elegido se traslapa con otro envío, elija otro."))};e.MakeEvent=function(){e.myPromise=r.getOverlap(e.currentEvent.start.format("YYYYMMDDHHmm"),e.currentEvent.end.format("YYYYMMDDHHmm")).success(v).error(u)},e.active=function(){return e.panes.filter(function(e){return e.active})[0]},e.SetDate=function(){i=$("#room1").fullCalendar(l),i.fullCalendar("gotoDate",e.dt),s()},e.ShowDetail=function(){e.desde=e.currentEvent.start.format("HH:mm"),e.hasta=e.currentEvent.end.format("HH:mm"),e.fecha=e.currentEvent.start.format("DD/MM/YYYY"),e.objetoEnvio.desde=e.currentEvent.start,e.objetoEnvio.hasta=e.currentEvent.end;var t=e.currentEvent.start.toDate().getTime(),n=e.currentEvent.end.toDate().getTime();e.horas=(n-t)/36e5,"$apply"!=e.$root.$$phase&&"$digest"!=e.$root.$$phase&&e.$apply()},e.Cancelar=function(){location.href="/"};var f=function(e,t,n,r){null!=e?($("#btnEnviar").button("reset"),o.success("Envio procesado, folio: "+e),setTimeout(function(){location.href="/"},1e3)):o.error("Error al guardar el consumo.")},E=function(t){var n=!0;return 1>t&&(o.error("Debe seleccionar un contacto."),n=!1),e.objetoEnvio.desde||(o.error("Debe elegir el periodo en el que se procesará el envío."),n=!1),e.objetoEnvio.remitente||(o.error("Debe capturar el remitente."),n=!1),e.objetoEnvio.destinatario||(o.error("Debe capturar el destinatario."),n=!1),e.objetoEnvio.material||(o.error("Debe capturar el material."),n=!1),e.objetoEnvio.lugar||(o.error("Debe capturar el lugar."),n=!1),n};e.Enviar=function(){var t=[];angular.forEach(e.gridOptions.selectedItems,function(e,n){t.push(e.mail)}),E(t.length)&&($("#btnEnviar").button("loading"),e.objetoEnvio.contactos=Enumerable.From(e.listaContacto).Where(function(e){return $.inArray(e.mail,t)>-1}).OrderBy(function(e){return e.idContacto}).Select(function(e){return e}).ToArray(),e.empleado=n.get("employeeLogged"),e.objetoEnvio.idEmpleado=e.empleado.idEmpleado,e.objetoEnvio.idActa=e.cliente.idActa,r.add(e.objetoEnvio).success(f).error(u))},e.Limpiar=function(){e.objetoEnvio=_Envio,e.usingCalendar=!1,i.fullCalendar("removeEvents","1")},e.today=function(){e.dt=new Date},e.clear=function(){e.dt=null},e.disabled=function(e,t){return"day"===t&&(-1===e.getDay()||7===e.getDay())},e.toggleMin=function(){e.minDate=e.minDate?null:new Date,e.maxDate=e.maxDate?null:new Date((new Date).getFullYear(),(new Date).getMonth()+3,1)},e.toggleMin(),e.open=function(t){t.preventDefault(),t.stopPropagation(),e.opened=!0},e.formats=["dd-MMMM-yyyy","yyyy/MM/dd","dd.MM.yyyy","shortDate"],e.format=e.formats[0]});